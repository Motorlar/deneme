let g=!1,h=null,c=null,a=null;function k(){c||(c=document.createElement("div"),c.className="element-selector-overlay",document.body.appendChild(c),a=document.createElement("div"),a.className="element-selector-label",document.body.appendChild(a))}function A(){c&&(c.remove(),c=null),a&&(a.remove(),a=null)}function N(t){if(t.id)return`#${t.id}`;if(t.className&&typeof t.className=="string"){const o=t.className.trim().split(/\s+/).filter(r=>r);if(o.length>0){const r=t.tagName.toLowerCase()+"."+o.join(".");if(document.querySelectorAll(r).length===1)return r}}let n=[],e=t;for(;e&&e.tagName;){let o=e.tagName.toLowerCase();if(e.id){n.unshift(`#${e.id}`);break}let r=e,f=1;for(;r.previousElementSibling;)r=r.previousElementSibling,r.tagName===e.tagName&&f++;if(f>1&&(o+=`:nth-of-type(${f})`),n.unshift(o),e=e.parentElement,n.length>5)break}return n.join(" > ")}function $(t){if(!c||!a)return;const n=t.getBoundingClientRect();c.style.top=`${n.top+window.scrollY}px`,c.style.left=`${n.left+window.scrollX}px`,c.style.width=`${n.width}px`,c.style.height=`${n.height}px`,c.style.display="block",a.textContent=h||"Element seçin",a.style.top=`${n.top+window.scrollY-30}px`,a.style.left=`${n.left+window.scrollX}px`,a.style.display="block"}function S(t){if(!g)return;t.preventDefault(),t.stopPropagation();const n=t.target;$(n)}function b(t){if(!g)return;t.preventDefault(),t.stopPropagation();const n=t.target,e=N(n),o=v(n);p(),chrome.runtime.sendMessage({type:"ELEMENT_SELECTED",data:{field:h,selector:e,sampleValue:o.substring(0,100)}})}function M(t){g=!0,h=t,k(),document.body.classList.add("element-selector-active"),document.addEventListener("mousemove",S,!0),document.addEventListener("click",b,!0)}function p(){g=!1,h=null,A(),document.body.classList.remove("element-selector-active"),document.removeEventListener("mousemove",S,!0),document.removeEventListener("click",b,!0)}function v(t){if(!t)return"";let n=t.textContent.trim();if(n)return n;const e=t.getAttribute("data-content");if(e)return e.trim();const r=window.getComputedStyle(t,"::before").getPropertyValue("content");if(r&&r!=="none"&&r!=="normal"){let i=r.replace(/^["']|["']$/g,"");const d=r.match(/attr\(([^)]+)\)/);if(d){const u=d[1],s=t.getAttribute(u);if(s)return s.trim()}if(i&&i!=="none")return i}const m=window.getComputedStyle(t,"::after").getPropertyValue("content");if(m&&m!=="none"&&m!=="normal"){let i=m.replace(/^["']|["']$/g,"");const d=m.match(/attr\(([^)]+)\)/);if(d){const u=d[1],s=t.getAttribute(u);if(s)return s.trim()}if(i&&i!=="none")return i}const E=t.querySelector("[data-content]");if(E){const i=E.getAttribute("data-content");if(i)return i.trim()}const w=t.querySelectorAll("*");for(let i of w){const u=window.getComputedStyle(i,"::before").getPropertyValue("content");if(u&&u!=="none"&&u!=="normal"){let s=u.replace(/^["']|["']$/g,"");const C=u.match(/attr\(([^)]+)\)/);if(C){const T=C[1],x=i.getAttribute(T);if(x)return x.trim()}if(s&&s!=="none")return s}}return""}function L(t){const n={};for(const[e,o]of Object.entries(t))try{const r=document.querySelector(o);n[e]=v(r)}catch(r){console.error(`Error extracting ${e}:`,r),n[e]=""}return n}function I(t){document.querySelectorAll(".extraction-highlight").forEach(n=>{n.classList.remove("extraction-highlight")});for(const n of Object.values(t))try{const e=document.querySelector(n);e&&e.classList.add("extraction-highlight")}catch(e){console.error("Error highlighting element:",e)}setTimeout(()=>{document.querySelectorAll(".extraction-highlight").forEach(n=>{n.classList.remove("extraction-highlight")})},2e3)}let l={isRunning:!1,links:[],currentIndex:0,config:null,extractedCount:0,totalCount:0};async function _(t){try{const n=document.querySelectorAll(t.customerListSelector),e=Array.from(n).map(o=>{const r=o.tagName==="A"?o:o.querySelector("a");return r?r.href:null}).filter(o=>o&&o.startsWith("http"));return e.length===0?{success:!1,error:"Müşteri linkleri bulunamadı!"}:(l={isRunning:!0,links:e,currentIndex:0,config:t,extractedCount:0,totalCount:e.length},y(),{success:!0,totalLinks:e.length})}catch(n){return console.error("Bulk extraction error:",n),{success:!1,error:n.message}}}function y(){if(!l.isRunning||l.currentIndex>=l.links.length){l.isRunning=!1,console.log(`Toplu veri çekme tamamlandı! ${l.extractedCount}/${l.totalCount} müşteri çekildi.`);return}const t=l.links[l.currentIndex];console.log(`[${l.currentIndex+1}/${l.totalCount}] Ziyaret ediliyor: ${t}`),window.location.href=t}function B(){if(!l.isRunning)return;const t=L(l.config.fieldMappings),n=t.phone||"";if(!n){console.log("Telefon numarası bulunamadı, atlanıyor..."),l.currentIndex++,setTimeout(()=>y(),1500);return}chrome.runtime.sendMessage({type:"SAVE_BULK_DATA",data:{configId:l.config.configId,customerData:t,sourceUrl:window.location.href}},e=>{e!=null&&e.success?(l.extractedCount++,console.log(`✓ Müşteri kaydedildi: ${t.full_name||"İsimsiz"} (${n})`)):e!=null&&e.duplicate?console.log(`⊘ Müşteri zaten kayıtlı: ${n}`):console.log(`✗ Kaydetme hatası: ${(e==null?void 0:e.error)||"Bilinmeyen hata"}`),l.currentIndex++,setTimeout(()=>y(),1500)})}window.addEventListener("load",()=>{l.isRunning&&l.currentIndex>0&&setTimeout(()=>B(),1e3)});chrome.runtime.onMessage.addListener((t,n,e)=>{if(t.type==="START_SELECTING")M(t.field),e({success:!0});else if(t.type==="STOP_SELECTING")p(),e({success:!0});else if(t.type==="EXTRACT_DATA"){const o=L(t.fieldMappings);I(t.fieldMappings),e({success:!0,data:o})}else if(t.type==="START_BULK_EXTRACTION"){const o=_(t.config);e(o)}else t.type==="STOP_BULK_EXTRACTION"&&(l.isRunning=!1,e({success:!0}));return!0});document.addEventListener("keydown",t=>{t.key==="Escape"&&g&&(p(),chrome.runtime.sendMessage({type:"SELECTION_CANCELLED"}))});
